{% extends 'data_monitoring/base.html' %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{% trans "Orders" %} {% trans "Search" %} - BSV-MES{% endblock %}
{% block header %}{% trans "Orders" %} {% trans "Search" %}{% endblock %}
{% block checkbox %}
<!-- Column display control checkboxes -->
<div class="dropdown d-inline-block me-2">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="columnToggleDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      {% trans "Select Columns" %}
    </button>
    <ul class="dropdown-menu" aria-labelledby="columnToggleDropdown">
      <li>
        <label class="dropdown-item">
          <input class="form-check-input me-2 column-toggle" type="checkbox" id="toggleOrderDateColumn" data-column="OrderDate">
          OrderDate
        </label>
      </li>
      <li>
        <label class="dropdown-item">
          <input class="form-check-input me-2 column-toggle" type="checkbox" id="toggleRTDColumn" data-column="RTD">
          RTD
        </label>
      </li>
      <li>
        <label class="dropdown-item">
          <input class="form-check-input me-2 column-toggle" type="checkbox" id="toggleETDColumn" data-column="ETD">
          ETD
        </label>
      </li>
      <li>
        <label class="dropdown-item">
          <input class="form-check-input me-2 column-toggle" type="checkbox" id="toggleSpecColumn" data-column="Spec">
          Spec
        </label>
      </li>
    </ul>
</div>
{% endblock %}
{% block forms %}
<form method="post" action="{% url 'data_monitoring:order_search' %}" onsubmit="return validateOrderNumber();" style="display: flex; align-items: center; width: 100%;">
    {% csrf_token %}
    <input class="form-control" type="search" placeholder="order number" aria-label="order number" id="order_number" name="order_number" style="width:30%; margin-right: 10px;" required autocomplete="off">
    <button class="btn btn-outline-success" type="submit">{% trans "Search" %}</button>
</form>
{% endblock %}
{% block url %}{% url 'data_monitoring:order_search' %}{% endblock %}
{% block table %}
{% if order_and_status %}
<text>Total {{ count }} results found.</text>
<div class="scrollable-tbody">
    <table class="table table-report" style="width:80%">
        <thead>
            <tr>
                <th>Order No</th>
                <th>Customer</th>
                <th>Order Type</th>
                <th class="orderdate-col">OrderDate</th>
                <th class="rtd-col">RTD</th>
                <th class="etd-col">ETD</th>                    
                <th>Brand</th>
                <th>Item</th>
                <th class="spec-col">Spec</th>
                <th>Color</th>
                <th>Pattern</th>
                <th>OrderQty</th>
                <th>Unit</th>
                <th>Bal.Qty</th>
                <th>Finish</th>
                <th>Update</th>
                <th>
                    <span class="filter-header" onclick="toggleFilter('nextStepFilter', event)">NextStep</span>
                    <div id="nextStepFilter" class="filter-dropdown" style="display: none;">
                        <div class="filter-options" id="filterOptions">
                            <!-- The checkboxes are added here dynamically -->  
                        </div>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for order, status in order_and_status %}
            <tr data-order="{{ order }}"
                data-status="{{ status|json_str }}"
                data-order-number="{{ order.order_no }}">
                <td>{{ order.order_no }}</td>
                <td>{{ order.customer_name }}</td>
                <td>{{ order.order_type }}</td>
                <td class="orderdate-col">{{ order.order_date|custom_date_format }}</td>
                <td class="rtd-col">{{ order.rtd|custom_date_format }}</td>
                <td class="etd-col">{{ order.etd|custom_date_format }}</td>
                <td>{{ order.brand }}</td>
                {% if order.spec|slice:"3:4" == '0' %}
                    <td>{{ order.item_name }} {{ order.spec|slice:":3" }}</td>
                {% else%}
                    <td>{{ order.item_name }} {{ order.spec|slice:":4" }}</td>
                {% endif %}
                <td class="spec-col">{{ order.spec }}</td>
                <td>{{ order.color_code }}</td>
                <td>{{ order.pattern }}</td>
                <td>{{ order.order_qty }}</td>
                <td>{{ order.qty_unit }}</td>
                <td>
                    <b>{{ status.bal_qty }}</b>
                </td>
                {% if status.latest_process %}
                    <td>
                        {{ status.latest_process|default_if_none:"" }} {{ status.latest_machine|slice:"-1:" }}
                    </td>
                    <td>
                        {{ status.latest_create_date|slice:"5:16"  }} {% if status.latest_create_date %} ({{ status.latest_create_date|elapsed_time }}) {% endif %}
                    </td>
                    {% if status.latest_process == 'DryPlan' %}
                        <td>
                            <span id="next_step" style="background-color: #FF4500; color: black; padding: 5px 10px; border-radius: 5px;"><b>MIXING</b></span>
                        </td>
                    {% elif status.latest_process == 'DryMix' %}
                        <td>
                            <span id="next_step" style="background-color: #FFC107; color: black; padding: 5px 10px; border-radius: 5px;"><b>PRODUCTION</b></span>
                        </td>
                    {% elif status.latest_process == 'DryLine' %}
                        {% if status.latest_machine == "bsvdl01" %}
                            <td>
                                <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>RP{% if status.line_shortage < 0 %} ({{ status.line_shortage }}M) {% endif %}</b></span>
                            </td>
                        {% elif status.latest_machine == "bsvdl02" %}
                            <td>
                                <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>RP{% if status.line_shortage < 0 %} ({{ status.line_shortage }}M) {% endif %}</b></span>
                            </td>
                        {% elif status.latest_machine == "bsvdl03" %}
                            <td>
                                <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>INSPECTION{% if status.line_shortage < 0 %} ({{ status.line_shortage }}M) {% endif %}</b></span>
                            </td>
                        {% elif status.latest_machine == "bsvdl04" %}
                            <td>
                                <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>INSPECTION{% if status.line_shortage < 0 %} ({{ status.line_shortage }}M) {% endif %}</b></span>
                            </td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% elif status.latest_process == 'RP' %}
                        <td>
                            <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>INSPECTION{% if status.line_shortage < 0 %} ({{ status.line_shortage }}M) {% endif %}</b></span>
                        </td>
                    {% elif status.latest_process == 'Inspection' %}
                        {% if status.qty_to_printing > 0 %}
                            <td>
                                <span id="next_step" style="background-color: #0099CC; color: black; padding: 5px 10px; border-radius: 5px;"><b>PRINTING({{ status.qty_to_printing }}M)</b></span>
                            </td>
                        {% elif status.bal_qty > 0 %}
                            <td>
                                <span id="next_step" style="background-color: #FFC107; color: black; padding: 5px 10px; border-radius: 5px;"><b>Add-Plan</b></span>
                            </td>
                        {% else %}
                            <td>
                                <span id="next_step" style="background-color: #3CB371; color: black; padding: 5px 10px; border-radius: 5px;"><b>SHIPMENT</b></span>
                            </td>
                        {% endif %}
                    {% elif status.latest_process == 'Printing' %}
                        <td>
                            <span id="next_step" style="background-color: #5986c9; color: black; padding: 5px 10px; border-radius: 5px;"><b>INSPECTION</b></span>
                        </td>
                    {% else %}
                        <td></td>
                    {% endif %}
                {% else %}
                    <td><span id="next_step"><b>N/A</b></span></td>
                    <td><span id="next_step"><b>N/A</b></span></td>
                    <td><span id="next_step"><b>N/A</b></span></td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No matching orders found.</p>
{% endif %} {% endblock %} {% block extra_js %}
<script>
    function toggleFilter(filterId, event) {
        event.stopPropagation();
        const filter = document.getElementById(filterId);
        filter.style.display = filter.style.display === 'none' ? 'block' : 'none';
    }
    
    function filterTable() {
        const table = document.querySelector('.table-report');
        const rows = table.querySelectorAll('tbody tr');
        const checkboxes = document.querySelectorAll('#nextStepFilter input[type="checkbox"]:checked');
        const selectedValues = Array.from(checkboxes).map(cb => cb.value);
    
        rows.forEach(row => {
            const nextStepCell = row.querySelector('td:last-child');
            if (nextStepCell) {
                const nextStepValue = nextStepCell.textContent.trim();
                if (selectedValues.length === 0 || selectedValues.some(value => {
                    if (value === '(N/A)') {
                        return nextStepValue === '';
                    }
                    return nextStepValue.includes(value);
                })) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        });
    }
    function populateFilterOptions() {
        const table = document.querySelector('.table-report');
        const rows = table.querySelectorAll('tbody tr');
        const nextStepValues = new Set();
    
        rows.forEach(row => {
            const nextStepCell = row.querySelector('td:last-child');
            if (nextStepCell) {
                const nextStepValue = nextStepCell.textContent.trim();
                if (nextStepValue === '') {
                    nextStepValues.add('(N/A)');
                } else {
                    nextStepValues.add(nextStepValue);
                }
            }
        });
    
        const filterOptions = document.getElementById('filterOptions');
        filterOptions.innerHTML = ''; // Remove all existing options  
    
        nextStepValues.forEach(value => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = value;
            checkbox.checked = true; // Set the checkbox to checked by default
            checkbox.onclick = filterTable;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${value}`));
            label.style.color = 'black'; // Set the filter text color to black
            filterOptions.appendChild(label);
        });
    }

    // Connect the filtering function to the page load and add a document click event listener
    document.addEventListener('DOMContentLoaded', function() {
        populateFilterOptions(); // Create filter options when the page loads

        // Close the filter window when the document is clicked
        document.addEventListener('click', function(event) {
            const filterDropdown = document.getElementById('nextStepFilter');
            if (filterDropdown.style.display === 'block' && !filterDropdown.contains(event.target)) {
                filterDropdown.style.display = 'none';
            }
        });

        // Prevent event propagation when clicking inside the filter dropdown
        const filterDropdown = document.getElementById('nextStepFilter');
        filterDropdown.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
</script>

<style>
  .filter-header {
    cursor: pointer;
  }

  .filter-dropdown {
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    padding: 12px;
    z-index: 1;
  }

  .filter-dropdown input[type="text"] {
    width: 100%;
    padding: 5px;
    margin-bottom: 10px;
  }

  .filter-options {
    max-height: 200px;
    overflow-y: auto;
  }

  .filter-options label {
    display: block;
    margin-bottom: 5px;
  }
</style>
{% endblock %}