{% extends 'common/main.html' %}
{% load i18n %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/report.css' %}">
<body>
<div class="report-container" id="dataContainer">
    <div class="report-row row" style="padding:10px">
        <div class="col-3">
            <h2>{% block header %}{% endblock %}</h2>
            {% block checkbox %}
            {% endblock %}
        </div>
        <div class="col-9">
            {% block forms %}
            {% endblock %}
            <div class="title-buttons" style="text-align: left;">
                <button onclick="generateQRCode()" title="QR" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-qrcode"></i>
                </button>
                <button onclick="toggleSearchPopup()" title="Search" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-search"></i>
                </button>
                <button type="button" title="List Search" onclick="openListSearchModal();" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-paste"></i>
                </button>
                <button onclick="exportTableToExcel()" title="Download as Excel" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-file-excel"></i>
                </button>
                <button onclick="captureTableAsImage()" title="Capture" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        </div>
    </div>
    <hr>
    {% block table %}
    {% endblock %}  {# 스크립트 블록 끝 #}

    <!-- 검색 팝업 창 -->
    <div id="searchPopup" class="popup">
        <!-- Form 태그 추가: action은 Django URLconf에 따라 수정해야 합니다. -->
        <form method="post" action="{% block url_search_popup %}{% endblock %}">
            {% csrf_token %}
            <div class="popup-content">
                <div>
                    <h5>OrderNo</h5>
                    <input type="text" id="orderNoInput" name="order_no" placeholder="Enter OrderNo">
                </div>
                <div>
                    <h5>Item</h5>
                    <input type="text" id="itemInput" name="item" placeholder="Enter Item">
                </div>
                <div>
                    <h5>ColorCode</h5>
                    <input type="text" id="colorCodeInput" name="color_code" placeholder="Enter ColorCode">
                </div>
                <div>
                    <h5>Pattern</h5>
                    <input type="text" id="patternInput" name="pattern" placeholder="Enter Pattern">
                </div>
                <div>
                    <h5>Customer</h5>
                    <input type="text" id="customerInput" name="customer" placeholder="Enter Customer">
                </div>
                <div>
                    <h5>OrderType</h5>
                    <input type="text" id="orderTypeInput" name="order_type" placeholder="Enter OrderType">
                </div>
                <div>
                    <h5>Start Date</h5>
                    <input type="date" id="startDateInput" name="start_date" value="{{ 30daysago|date:'Y-m-d' }}">
                </div>
                <div>
                    <h5>End Date</h5>
                    <input type="date" id="endDateInput" name="end_date" value="{{ today|date:'Y-m-d' }}">
                </div>
            </div>
        </form>
    </div>

    <!-- List Search Modal -->
    <div class="modal fade" id="listSearchModal" tabindex="-1" role="dialog" aria-labelledby="listSearchModalLabel" aria-hidden="true" style="z-index: 9999;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <h5 class="modal-title" id="listSearchModalLabel">{% trans 'Order List Search' %}</h5>
                <form id="listOrderForm" method="post" action="{% block url_list_search %}{% endblock %}">
                    {% csrf_token %}
                    <textarea class="form-control" name="order_numbers" id="listOrderInput" rows="10" placeholder="Enter order numbers, one per line"></textarea>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeListSearchModal()">{% trans 'Close' %}</button>
                    <button type="button" class="btn btn-primary" onclick="searchListOrders();">{% trans 'Search' %}</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 컨텍스트 메뉴 추가 -->
    <div id="context-menu" class="context-menu">
        <ul>
            <li onclick="action1()">Status Info</li>
            <li onclick="action2()">Add to mylist</li>
            <li onclick="action3()">Comment</li>
            <li onclick="action4()">To urgent</li>
        </ul>
    </div>

    <!-- 모달 창 추가 -->
    <div id="infoModal" class="modal" style="z-index: 9999;">
        <div class="modal-content" style="width:50%;">
            <span class="close">&times;</span>
            <h2>Status Information</h2>
            <p id="modalStatusInfo"></p>
        </div>
    </div>

</div>
{% endblock %}
{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
<script>
    function generateQRCode() {
        const table = document.querySelector('.table-report');
        const rows = table.querySelectorAll('tbody tr');
        const orderNumbers = Array.from(rows).map(row => row.cells[0].textContent.trim());
    
        const csrftoken = getCookie('csrftoken');
        const payload = {
            action: 'download_to_qrcard',
            order_numbers: orderNumbers.join(',')
        };
    
        fetch('/data_monitoring/order_search/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "qrcard.xlsx";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to download file.");
        });
    }
    </script>
<script>
    function handleColumnToggle() {
        const checkboxes = document.querySelectorAll('.column-toggle');
        const currentPage = window.location.pathname;
    
        checkboxes.forEach(checkbox => {
            const columnName = checkbox.dataset.column;
            const storageKey = `${currentPage}_${columnName}_visible`;
    
            // 페이지 로드 시 저장된 상태 복원 또는 기본값 설정
            const savedState = localStorage.getItem(storageKey);
            const isChecked = savedState === null ? true : savedState === 'true';
            checkbox.checked = isChecked;
            toggleColumnVisibility(columnName, isChecked);
    
            // 체크박스 상태 변경 시 저장 및 열 표시/숨김 처리
            checkbox.addEventListener('change', function() {
                localStorage.setItem(storageKey, this.checked);
                toggleColumnVisibility(columnName, this.checked);
            });
        });
    }
    
    // 열 표시/숨김 처리 함수
    function toggleColumnVisibility(columnName, isVisible) {
        const columnClass = columnName.toLowerCase() + '-col';
        const cells = document.querySelectorAll(`.${columnClass}`);
        cells.forEach(cell => {
            cell.style.display = isVisible ? '' : 'none';
        });
    }
    
    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', handleColumnToggle);
    
    document.getElementById('searchPopup').addEventListener('keypress', function(event) {
        if (event.keyCode === 13) { // Enter 키의 keyCode는 13입니다.
            event.preventDefault(); // 폼이 자동으로 제출되는 것을 방지합니다.
            toggleSearchPopup(); // 검색 실행 함수를 호출합니다.
        }
    });
    document.addEventListener('click', function(event) {
        var popup = document.getElementById('searchPopup');
        var searchButton = document.querySelector('button[onclick="toggleSearchPopup()"]');
        // 팝업이 열려 있고, 클릭한 요소가 팝업 내부에 있지 않으며, 검색 버튼이 아닐 때 팝업을 닫습니다.
        if (popupVisible && !popup.contains(event.target) && !searchButton.contains(event.target)) {
            closeSearchPopup(popup);
            popupVisible = false;
        }
    });
    function exportTableToExcel() {
        var wb = XLSX.utils.table_to_book(document.querySelector('table'), {
            sheet:"Sheet JS",
            raw: true  // 모든 데이터를 원시 문자열로 처리
        });
        var wbout = XLSX.write(wb, {bookType:'xlsx', bookSST:true, type: 'binary'});
    
        function s2ab(s) {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }
    
        // 헤더 내용을 가져옵니다.
        var headerContent = document.querySelector('h2').textContent.trim();
    
        // 파일 이름을 헤더 내용으로 설정합니다.
        saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), headerContent + '.xlsx');
    }
    function showSearchPopup() {
        var popup = document.getElementById('searchPopup');
        var searchButton = document.querySelector('button[onclick="showSearchPopup()"]');
        
        var buttonRect = searchButton.getBoundingClientRect(); // 검색 버튼의 위치 정보를 가져옵니다.
        var popupHeight = popup.clientHeight;
    
        popup.style.top = buttonRect.bottom + 'px'; // 버튼 아래에 위치하도록 설정합니다.
        popup.style.left = buttonRect.right + 'px';
    
        popup.style.display = 'block';
        setTimeout(function () {
            popup.style.opacity = '1';
        }, 300);
    }
    
    function closeSearchPopup() {
        var popup = document.getElementById('searchPopup');
        popup.style.opacity = '0';
        setTimeout(function () {
            popup.style.display = 'none';
        }, 300);
    }

    var popupVisible = false; // 팝업 창의 상태를 나타내는 변수 추가

    function openListSearchModal() {
        $('#listSearchModal').modal('show');
    }
    
    function closeListSearchModal() {
        $('#listSearchModal').modal('hide');
    }
    
    function searchListOrders() {
        const input = document.getElementById('listOrderInput').value.trim();
    
        if (input === "") {
            alert('Please enter at least one order number.');
            return;
        }
    
        const orderLines = input.split('\n');
        const orderNumbers = orderLines.map(line => {
            const orderNumberList = line.replace(/\t/g, '-');
            return orderNumberList;
        });
        document.getElementById('listOrderInput').value = orderNumbers;
        const form = document.getElementById('listOrderForm');  // form 객체를 올바르게 참조
        form.submit();  // form  제출
        closeListSearchModal('listSearchModal');
    }

    function validateOrderNumber() {
        const orderNumber = document.getElementById('order_number').value;
        if (orderNumber.length < 6) {
            alert('Order number must be at least 6 characters long.');
            return false;
        }
        return true;
    }

    function validateDates(startDateInput, endDateInput) {
        if (startDateInput && endDateInput) {
            var startDate = new Date(startDateInput);
            var endDate = new Date(endDateInput);
            var sixMonths = 6 * 30; // 대략 6개월을 일수로 환산
    
            var timeDiff = endDate - startDate;
            var daysDiff = timeDiff / (1000 * 3600 * 24); // 밀리초 차이를 일수로 환산
    
            if (daysDiff > sixMonths) {
                alert("Date range cannot exceed 6 months.");
                return false;
            }
        }
        return true;
    }

    function toggleSearchPopup() {
        var popup = document.getElementById('searchPopup');
        if (popupVisible) {
            // 팝업 창이 열려 있을 때, 폼을 제출하고 팝업을 닫습니다.
            // 폼 제출 로직을 여기로 이동합니다.
            var orderNoInput = document.getElementById('orderNoInput').value;
            var itemInput = document.getElementById('itemInput').value; // Item 값 받기
            var colorCodeInput = document.getElementById('colorCodeInput').value;
            var patternInput = document.getElementById('patternInput').value;
            var customerInput = document.getElementById('customerInput').value;
            var orderTypeInput = document.getElementById('orderTypeInput').value;
            var startDateInput = document.getElementById('startDateInput').value;
            var endDateInput = document.getElementById('endDateInput').value;
            
            // 입력 값이 없으면 검색을 실행하지 않음
            if (
                orderNoInput.trim() === "" 
                && itemInput.trim() === "" 
                && colorCodeInput.trim() === "" 
                && patternInput.trim() === "" 
                && customerInput.trim() === "" 
                && orderTypeInput.trim() === ""
                ) {
                alert("Please enter at least one search criteria.");
                return; // 경고 후 추가 작업 중단
            }
            if (orderNoInput.length >= 1 && orderNoInput.length < 6) {
                // 입력 값이 6자리 미만일 경우 경고 팝업을 띄웁니다.
                alert("'OrderNo' must be at least 6 characters long.");
                return; // 추가 작업을 중단합니다.
            }
            if (itemInput.length >= 1 && itemInput.length < 4) {
                // 입력 값이 6자리 미만일 경우 경고 팝업을 띄웁니다.
                alert("'Item' must be at least 4 characters long.");
                return; // 추가 작업을 중단합니다.
            }
            if (colorCodeInput.length >= 1 && colorCodeInput.length < 3) {
                // 입력 값이 6자리 미만일 경우 경고 팝업을 띄웁니다.
                alert("'ColorCode' must be at least 3 characters long.");
                return; // 추가 작업을 중단합니다.
            }
            if (patternInput.length == 1) {
                // 입력 값이 6자리 미만일 경우 경고 팝업을 띄웁니다.
                alert("'Pattern' must be at least 2 characters long.");
                return; // 추가 작업을 중단합니다.
            }
            if (customerInput.length == 1) {
                // 입력 값이 1자리일 경우 경고 팝업을 띄웁니다.
                alert("'Customer' must be at least 2 characters long.");
                return; // 추가 작업을 중단합니다.
            }
            if (!validateDates(startDateInput, endDateInput)) {
                return; // 날짜 범위가 유효하지 않으면 중단
            }
            document.forms[0].submit(); // 폼이 하나만 있다고 가정합니다. 그렇지 않은 경우 적절한 선택자를 사용해야 합니다.
            popup.style.opacity = '0';
            setTimeout(function () {
                popup.style.display = 'none';
            }, 300);
        } else {
            // 팝업 창이 닫혀 있을 때, 열도록 합니다.
            var searchButton = document.querySelector('button[onclick="toggleSearchPopup()"]');
            var buttonRect = searchButton.getBoundingClientRect();
            var leftPosition = buttonRect.right + 20; // 버튼의 우측에 20px 간격을 두고 위치
            var windowWidth = window.innerWidth;

            // 팝업이 화면 밖으로 나가지 않도록 조정
            if (leftPosition + 600 > windowWidth) { // 600px은 팝업의 최대 너비
                leftPosition = windowWidth - 620; // 오른쪽 여백을 고려하여 조금 이동
            }
            popup.style.top = buttonRect.bottom + 'px';
            popup.style.left = leftPosition  + 'px';
            popup.style.display = 'block';
            setTimeout(function () {
                popup.style.opacity = '1';
            }, 300);
        }
        popupVisible = !popupVisible;
    }
    
    // 컨텍스트 메뉴 스크립트
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.querySelector('.table-report');
        const contextMenu = document.getElementById('context-menu');

        table.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            clickedRow = e.target.closest('tr'); // 클릭된 행을 전역 변수에 저장
            const { clientX: mouseX, clientY: mouseY } = e;
            contextMenu.style.top = `${mouseY}px`;
            contextMenu.style.left = `${mouseX}px`;
            contextMenu.style.display = 'block';
        }, false);

        document.addEventListener('click', function(e) {
            contextMenu.style.display = 'none';
        }, false);
    });
    
    function elapsedTime(timeDifferenceMs) {
        
        // 밀리초를 일, 시간, 분 단위로 변환
        const days = Math.floor(timeDifferenceMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDifferenceMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDifferenceMs % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
            return `${days} days ${hours} hours`;
        } else if (hours > 0) {
            return `${hours} hours ${minutes} minutes`;
        } else {
            return `${minutes} minutes`;
        }
    };

    function action1() {
        if (!clickedRow) return; // 클릭된 행이 없으면 함수 종료

        // 클릭된 행에서 데이터 속성 가져오기
        const dataStatus = clickedRow.getAttribute('data-status');

        // JSON 문자열을 객체로 변환 (파싱)
        const statusInfo = JSON.parse(dataStatus);

        // 모달 창 요소 선택
        const modal = document.getElementById('infoModal');
        const modalOrderDetails = document.getElementById('modalOrderDetails');

        let ProcessInfo = ``;

        for (let i = 0; i < Object.keys(statusInfo.process).length; i++) {
            let headers = "";
            let values = "";

            if (statusInfo.process[i].process == 'DryPlan') {
                headers = `
                    <tr style="background-color: #FF4500;">                        
                        <th>Plan Date</th>
                        <th>Process</th>
                        <th>Plan Qty</th>
                        <th>Skin Resin</th>
                        <th>Binder Resin</th>
                        <th>Base</th>
                    </tr>
                `;
                values = `
                    <tr>
                        <td>${statusInfo.process[i].plan_date}</td>
                        <td>${statusInfo.process[i].process} ${statusInfo.process[i].machine.slice(-1)}</td>
                        <td>${statusInfo.process[i].plan_qty} M</td>
                        <td>${statusInfo.process[i].skin_resin}</td>
                        <td>${statusInfo.process[i].binder_resin}</td>
                        <td>${statusInfo.process[i].base}</td>
                    </tr>
                `;
            } else if (statusInfo.process[i].process == 'DryMix') {
                mixing_time = new Date(statusInfo.process[i].create_date.replace(' ', 'T'));
                headers = `
                    <tr style="background-color: #FFC107;">                        
                        <th>Date</th>
                        <th>Process</th>
                `;
                for (const key of Object.keys(statusInfo.process[i].chemical)) {
                    headers += `
                        <th>${key}</th>
                    `;
                }
                headers += `
                    </tr>
                `;
                values = `
                    <tr>
                        <td>${statusInfo.process[i].create_date.slice(0,16)}</td>
                        <td>${statusInfo.process[i].process} ${statusInfo.process[i].machine.slice(-1)}</td>
                `;
                values += `
                        {% if "production_managers" in user_groups %}
                    `;
                for (const value of Object.values(statusInfo.process[i].chemical)) {
                    values += `
                        <td>${value}</td>
                    `;
                }
                values += `
                        {% else %}
                    `;
                for (const value of Object.values(statusInfo.process[i].chemical)) {
                    values += `
                        <td>???</td>
                    `;
                }
                values += `
                    </tr>
                    {% endif %}
                `;
            } else if (statusInfo.process[i].process == 'DryLine') {
                dryline_time = new Date(statusInfo.process[i].create_date.replace(' ', 'T'));
                let swt;
                if (typeof mixing_time !== 'undefined') {
                    swt = elapsedTime(dryline_time - mixing_time);
                } else {
                    swt = `N/A`;
                }
                headers = `
                    <tr style="background-color: #5986c9;">
                        <th>Date</th>
                        <th>Process</th>
                        <th>Production Qty</th>
                        <th>Waiting</th>
                    </tr>
                `;
                values = `
                    <tr>                        
                        <td>${statusInfo.process[i].create_date.slice(0,16)}</td>
                        <td>${statusInfo.process[i].process} ${statusInfo.process[i].machine.slice(-1)}</td>
                        <td>${statusInfo.process[i].pd_qty} M</td>
                        <td>${swt}</td>
                    </tr>
                `;
            } else if (statusInfo.process[i].process == 'RP') {
                delami_time = new Date(statusInfo.process[i].create_date.replace(' ', 'T'));
                let at;
                if (typeof dryline_time !== 'undefined') {
                    at = elapsedTime(delami_time - dryline_time);
                } else {
                    at = `N/A`;
                }
                headers = `
                    <tr style="background-color: #5986c9;">                        
                        <th>Date</th>
                        <th>Process</th>
                        <th>Delamination Qty</th>
                        <th>Aging</th>
                    </tr>
                `;
                values = `
                    <tr>                        
                        <td>${statusInfo.process[i].create_date.slice(0,16)}</td>
                        <td>${statusInfo.process[i].process} ${statusInfo.process[i].machine.slice(-1)}</td>
                        <td>${statusInfo.process[i].delami_qty} M</td>
                        <td>${at}</td>
                    </tr>
                `;
            } else if (statusInfo.process[i].process == 'Inspection') {
                headers = `
                    <tr style="background-color: #3CB371;">                        
                        <th>Date</th>
                        <th>Process</th>
                        <th>A Grade</th>
                    </tr>
                `;
                values = `
                    <tr>                        
                        <td>${statusInfo.process[i].create_date.slice(0,16)}</td>
                        <td>${statusInfo.process[i].process} ${statusInfo.process[i].machine.slice(-1)}</td>
                        <td>${statusInfo.process[i].agrade_qty} M</td>
                    </tr>
                `;
            } else {

            }

            ProcessInfo += `
            <table class="table table-bordered" style="width:100%; margin-bottom: 20px;">
                <thead>${headers}</thead>
                <tbody>${values}</tbody>
            </table>
            `;
        }

        document.getElementById('modalStatusInfo').innerHTML = ProcessInfo;
        modal.style.display = 'block';
    }
    
    // 모달 창을 닫는 기능
    const modal = document.getElementById('infoModal');
    const closeModal = modal.querySelector('.close');
    closeModal.onclick = function() {
        modal.style.display = 'none';
    }

    // 모달 창 외부를 클릭하면 닫히도록 함
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    function action2() {
        if (!clickedRow) return;
        const my_list = clickedRow.getAttribute('data-order-number');
        
        const csrftoken = getCookie('csrftoken');
        const payload = {
            action: 'add_to_my_list',
            my_list: my_list,
            content: {'Line': true}
        };
        
        // console.log(JSON.stringify(payload)); // 로그로 데이터 형식 확인
    
        $.ajax({
            url: '/ppm/report/order_search/',
            type: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            data: JSON.stringify(payload),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(response) {
                if (response.status === "success") {
                    alert("My list has been updated successfully.");
                } else if (response.status === "overlap") {
                    alert("ERROR : Already exist!");
                } else {
                    alert("UNKNOWN ERROR");
                }
            },
            error: function(xhr, status, error) {
                alert("Error occurred!");
            }
        });
    }
    
    // CSRF 토큰을 쿠키에서 가져오는 함수
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function action3() {
        alert('Now Preparing..!');
    }
    function action4() {
        alert('Now Preparing..!');
    }
    function captureTableAsImage() {
            const table = document.querySelector('.table');
            
            // 테이블의 행 수를 계산 (thead 내 행은 제외)
            const rowCount = table.querySelectorAll('tbody tr').length;
        
            // 행 수가 100건 이상인 경우 작동하지 않음
            if (rowCount >= 100) {
                alert('Table is too large to capture (100 rows maximum).');
                return;
            }
            
            // 필요할 때만 html2canvas 로드 및 사���
            if (typeof html2canvas !== 'function') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js';
                document.head.appendChild(script);
                script.onload = () => {
                    html2canvas(table).then(canvas => {
                        canvas.toBlob(function(blob) {
                            const item = new ClipboardItem({ "image/png": blob });
                            navigator.clipboard.write([item]);
                            alert('Table captured and copied to clipboard!');
                        });
                    });
                };
            } else {
                html2canvas(table).then(canvas => {
                    canvas.toBlob(function(blob) {
                        const item = new ClipboardItem({ "image/png": blob });
                        navigator.clipboard.write([item]);
                        alert('Table captured and copied to clipboard!');
                    });
                });
        }
    }
</script>
{% block extra_js %}{% endblock %}
</body>
{% endblock %}  {# 스크립트 블록 끝 #}