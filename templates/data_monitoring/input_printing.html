{% extends "data_monitoring/input_base.html" %} {% load static %}
{% block title %}PRODUCTION-DATA QR SYSTEM - PRINTING{% endblock %}
{% block header %}PRODUCTION-DATA QR SYSTEM - PRINTING{% endblock %} {% block content %} 
{% endblock %} {% block extra_js %}
<script>
  $(document).ready(function () {
    // When the page loads, clear the 'Production Quantity' input field.
    $("#qty").val("");

    // Update the quantityInput variable whenever the 'qty' field value changes.
    $("#qty").change(function () {
      quantityInput = $(this).val(); // Set the input value to the quantityInput variable.
    });

    var decimalButton = document.querySelector(".decimal");
    // Hide the button if it exists.
    if (decimalButton) {
      decimalButton.style.display = "none";
    }
  });

  let nextBtnState = 0;
  let scannedOrdersData;

  $("#nextBtn").on("click", handleNextButtonClick);

  function handleNextButtonClick() {
    nextBtnState++;
    switch (nextBtnState) {
      case 1:
        handleFirstClick();
        break;
      case 2:
        handleSecondClick();
        break;
      case 3:
        handleThirdClick();
        break;
      case 4:
        handleFourthClick();
        break;
      default:
        resetPage();
    }
  }

  function handleFirstClick() {
    updateScannedQRCodes();
    updateQRSummary();
    clearOrderInfo();
    disableAddButton();
  }

  function handleSecondClick() {
    addQuantityInput();
    showQuantityInput();
    setupTableToggle();
  }

  function handleThirdClick() {
    const quantityInput = $("#qty").val();
    if (quantityInput == "0") {
      showDefectSelectionForm();
    } else {
      sendDataToServer(quantityInput);
    }
  }

  function handleFourthClick() {
    // Get the selected defects and send them to the server
    const defectSelects = $(".defect-select");
    const defectCauses = [];

    // Collect all selected defect causes.
    defectSelects.each(function () {
      const defectCode = $(this).val();
      if (defectCode) {
        defectCauses.push(defectCode);
      }
    });

    if (defectCauses.length === 0) {
      alert("Vui lòng chọn ít nhất một lỗi");
      nextBtnState = 3; // Go back to the defect selection state.
      return;
    }

    // Create an array of defect causes.
    const printInfo = defectCauses.map((defectCause) => ({
      defectCause: defectCause,
    }));

    sendDataToServer(0, printInfo);
  }

  function showDefectSelectionForm() {
    const htmlContent = `
      <div class="form-group">
        <label><h3>CHỌN LỖI KHÔNG THỂ SỬA MÀU</h3></label>
        <div id="defectSelections">
          <div class="defect-row mb-2">
            <div class="d-flex">
              <select class="form-control defect-select" required>
                <option value="">-- Chọn lỗi --</option>
                {% for code, name in defect_cause.items %}
                <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-success ml-2 add-defect">+</button>
            </div>
          </div>
        </div>
      </div>`;

    $("#quantityInputContainer").html(htmlContent);

    // Add event handler for the "+" button.
    $("#quantityInputContainer").on("click", ".add-defect", function () {
      const newRow = `
        <div class="defect-row mb-2">
          <div class="d-flex">
            <select class="form-control defect-select" required>
              <option value="">-- Chọn lỗi --</option>
              {% for code, name in defect_cause.items %}
              <option value="{{ code }}">{{ name }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-danger ml-2 remove-defect">-</button>
          </div>
        </div>`;
      $("#defectSelections").append(newRow);
    });

    // Add event handler for the "-" button
    $("#quantityInputContainer").on("click", ".remove-defect", function () {
      $(this).closest(".defect-row").remove();
    });
  }

  function addQuantityInput() {
    const htmlContent = `
      <label class="col-6"><h3>SỐ LƯỢNG ĐÃ SỬA MÀU</h3></label>
      <div class="row">
        <input style="font-size: 128px;" type="text" id="qty" name="qty" class="form-control col-10 form-control-lg">
        <label style="font-size: 128px;" class="col-2">M</label>
      </div>`;
    $("#addButtonContainer").html(htmlContent);
  }

  function showQuantityInput() {
    $("#quantityInputContainer").show();
    $("#qty").focus();
    $("#scannedOrdersTable").hide();
  }

  function sendDataToServer(quantityInput, printInfo = null) {
    $("#keypad").hide();

    const data = {
      scannedOrders: scannedQRCodes,
      quantityInput: quantityInput,
      machine: machineValue,
    };

    if (printInfo) {
      data.print_information = printInfo;
    }

    $.ajax({
      url: window.location.pathname,
      type: "POST",
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: handleServerResponse,
      error: handleServerError,
    });
  }

  function toggleTableVisibility() {
    $("#scannedOrdersTable").toggle();
    const buttonText = $("#scannedOrdersTable").is(":visible")
      ? "Giấu"
      : "Hiện";
    $(".toggle-button").text(buttonText);
  }

  // Update the quantityInput variable when the input field value changes.
  function updateQuantityInput() {
    quantityInput = $("#qty").val();
  }

  // Add an 'input' event listener to call the updateQuantityInput function whenever the input field value changes.
  $("#qty").on("input", updateQuantityInput);
</script>
{% endblock %}
