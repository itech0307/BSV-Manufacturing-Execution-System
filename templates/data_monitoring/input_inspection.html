{% extends "data_monitoring/input_base.html" %} {% block title %}PRODUCTION-DATA
QR SYSTEM (INSPECTION){% endblock %} {% block header %}PRODUCTION-DATA QR SYSTEM
(INSPECTION){% endblock %} {% block content %} {% endblock %} {% block extra_js %}
<script>
  $(document).ready(function () {
    var decimalButton = document.querySelector(".decimal");
    // Hide the decimal button if it exists
    decimalButton.style.display = "none";
  });
  let nextBtnState = 0;
  let scannedOrdersData;

  $("#nextBtn").on("click", handleNextButtonClick);

  function handleNextButtonClick() {

    nextBtnState++;
    switch (nextBtnState) {
      case 1:
        handleFirstClick();
        break;
      case 2:
        handleSecondClick();
        break;
      default:
        resetPage();
    }
  }

  function handleFirstClick() {
    updateScannedQRCodes();
    updateQRSummary();
    clearOrderInfo();
    addAgradeQuantity();
    showQuantityInput();
    disableAddButton();
  }

  function handleSecondClick() {
    sendDataToServer();
  }

  function showQuantityInput() {
    $("#quantityInputContainer").show();
  }

  function sendDataToServer() {
    $("#keypad").hide();

    // Determine next_step based on input type
    let selectedNextProcess = '';
    const printingQty = quantityInput.find(x => x.Grade === 'Printing');
    if (printingQty) {
        selectedNextProcess = 'PRINTING';
    }

    $.ajax({
        url: "/data_monitoring/input_inspection/",
        type: "POST",
        data: JSON.stringify({
            scannedOrders: scannedQRCodes,
            quantityInput: quantityInput,
            machine: machineValue,
            selectedNextProcess: selectedNextProcess
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: handleServerResponse,
        error: handleServerError
    });
  }

  const quantityInput = [{ Grade: "A", quantity: 0 }];

  function addAgradeQuantity() {
    parentDiv = $("#quantityInputTable");

    // Create container for A-grade
    const aGradeContainer = $('<div id="aGradeContainer" class="mb-4"></div>');

    // Create flex container for A-grade
    const flexContainer = $('<div class="d-flex align-items-center"></div>');

    // Add "A Grade" label
    const label = $('<label style="width:50%; font-size:35px;">A Grade:</label>');

    // Create input field for A Grade quantity
    const aGradeQuantityInput = $(
        '<input type="text" class="form-control form-control-lg numeric-input required" style="width:50%" placeholder="Qty *">'
    );

    // Add unit label "M"
    const unitLabel = $('<span class="ml-2">M</span>');

    // Add components to flex container
    flexContainer.append(label);
    flexContainer.append(aGradeQuantityInput);
    flexContainer.append(unitLabel);

    // Add flex container to A-grade container
    aGradeContainer.append(flexContainer);

    // Add A-grade container to parent
    parentDiv.append(aGradeContainer);

    // Add button container
    parentDiv.append(addButtonContainer);

    // Create container for Printing quantity
    const printingContainer = $('<div id="printingContainer" class="mt-4"></div>');

    // Create flex container for Printing
    const printingFlexContainer = $('<div class="d-flex align-items-center"></div>');

    // Add "To Printing" label
    const printingLabel = $('<label style="width:50%; font-size:35px;">To Printing:</label>');

    // Create input field for Printing quantity
    const printingQuantityInput = $(
        '<input type="text" class="form-control form-control-lg numeric-input" style="width:50%" placeholder="Qty">'
    );

    // Add unit label "M"
    const printingUnitLabel = $('<span class="ml-2">M</span>');

    // Add components to printing flex container
    printingFlexContainer.append(printingLabel);
    printingFlexContainer.append(printingQuantityInput);
    printingFlexContainer.append(printingUnitLabel);

    // Add printing flex container to printing container
    printingContainer.append(printingFlexContainer);

    // Add printing container to parent
    parentDiv.append(printingContainer);

    // Handle A-grade input
    aGradeQuantityInput.on('input', function() {
        const quantity = $(this).val();
        if (quantity && quantity > 0) {
            // Disable Printing input and clear its value
            printingQuantityInput.val('').prop('disabled', true);
            // Update quantityInput array
            const existingAgrade = quantityInput.find(x => x.Grade === 'A');
            if (existingAgrade) {
                existingAgrade.quantity = quantity;
            } else {
                quantityInput.push({ Grade: 'A', quantity: quantity });
            }
            // Enable defect input
            $('.addQtyBtn').prop('disabled', false);
        } else {
            // Enable Printing input
            printingQuantityInput.prop('disabled', false);
            // Remove A-grade from quantityInput array
            const agradeIndex = quantityInput.findIndex(x => x.Grade === 'A');
            if (agradeIndex > -1) {
                quantityInput.splice(agradeIndex, 1);
            }
        }
    });

    // Handle Printing input
    printingQuantityInput.on('input', function() {
        const quantity = $(this).val();
        if (quantity && quantity > 0) {
            // Disable A-grade input and clear its value
            aGradeQuantityInput.val('').prop('disabled', true);
            // Clear all defect inputs
            $('.defect-cause-container').remove();
            // Disable add defect button
            $('.addQtyBtn').prop('disabled', true);
            // Clear quantityInput array and add only printing quantity
            quantityInput.length = 0;
            quantityInput.push({
                Grade: 'Printing',
                quantity: quantity,
                next_step: 'PRINTING'
            });
        } else {
            // Enable A-grade input
            aGradeQuantityInput.prop('disabled', false);
            // Enable add defect button
            $('.addQtyBtn').prop('disabled', false);
            // Remove printing from quantityInput array
            const printingIndex = quantityInput.findIndex(x => x.Grade === 'Printing');
            if (printingIndex > -1) {
                quantityInput.splice(printingIndex, 1);
            }
        }
    });
  }

  function addNewItem() {
    const parentDiv = $("#quantityInputTable");
    const addButtonContainer = $("#addButtonContainer");

    // Get and process defect causes
    const defectCauseOptions = JSON.parse("{{ defect_cause|escapejs }}");
    const sortedDefectCauses = Object.keys(defectCauseOptions).sort((a, b) =>
      defectCauseOptions[a].localeCompare(defectCauseOptions[b])
    );

    const defectCauseContainer = $(
      '<div class="defect-cause-container"></div>'
    ); // Create grid container

    // Add items in grid format
    sortedDefectCauses.forEach((key) => {
      const gridItem = $(
        `<div class="grid-item" data-key="${key}">${defectCauseOptions[key]}</div>`
      );
      gridItem.on("click", function () {
        const defectCauseKey = $(this).data("key");
        const defectCauseText = defectCauseOptions[defectCauseKey];
        $("#categoryModal").modal("hide"); // Close modal

        const flexContainer = $(
          '<div class="d-flex align-items-center"></div>'
        );

        // Add quantity input field
        const quantityInputField = $(
          `<input type="text" id="${defectCauseKey}" name="${defectCauseKey}" class="form-control form-control-lg numeric-input col-2" style="width:30%">`
        );
        const unitLabel = $('<span class="ml-2">M</span>');

        flexContainer.append(
          `<span class="mr-2"><h3>${defectCauseText}</h3></span>`
        ); // Add selected item name
        flexContainer.append(quantityInputField); // Add quantity input field to flex container
        flexContainer.append(unitLabel); // Add unit label to flex container
        parentDiv.append(flexContainer); // Add complete flex container to parent div
        parentDiv.append(addButtonContainer); // Add addButtonContainer below flex container

        quantityInputField.focus(); // Set focus to new input field

        // Add event handler for quantity input field
        quantityInputField.on("input", function () {
          const quantity = $(this).val();
          // Find current defectCauseKey in quantityInput array
          const existingItemIndex = quantityInput.findIndex(
            (x) => x.defectCause === defectCauseKey
          );

          if (existingItemIndex !== -1) {
            // If already exists, update quantity for this defectCause
            quantityInput[existingItemIndex].quantity = quantity;
          } else {
            // Add new defectCause to array
            quantityInput.push({
              defectCause: defectCauseKey,
              quantity: quantity,
            });
          }
        });
      });
      defectCauseContainer.append(gridItem);
    });

    $("#categoryModal .modal-body").html(defectCauseContainer); // Add grid container to modal body
    $("#categoryModal").modal("show"); // Show modal
  }

  // Add validation function for A Grade quantity
  {% comment %} function validateAGradeQuantity() {
    const aGradeInput = $("input.numeric-input.required").val();
    if (
      !aGradeInput ||
      aGradeInput.trim() === "" ||
      parseFloat(aGradeInput) <= 0
    ) {
      alert("Please enter A Grade quantity before continuing!");
      nextBtnState = 1;
      return false;
    }
    return true;
  } {% endcomment %}
</script>
{% endblock %}
