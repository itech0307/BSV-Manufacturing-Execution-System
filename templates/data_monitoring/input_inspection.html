{% extends "data_monitoring/input_base.html" %} {% block title %}PRODUCTION-DATA
QR SYSTEM (INSPECTION){% endblock %} {% block header %}PRODUCTION-DATA QR SYSTEM
(INSPECTION){% endblock %} {% block content %} {% endblock %}
{% block extra_js %}
<script>
  $(document).ready(function () {
    var decimalButton = document.querySelector(".decimal");
    // Hide the decimal button if it exists
    decimalButton.style.display = "none";
  });
  let nextBtnState = 0;
  let scannedOrdersData;

  $("#nextBtn").on("click", handleNextButtonClick);

  function handleNextButtonClick() {
    if (nextBtnState === 1) {
      if (!validateAGradeQuantity()) {
        return;
      }
    }

    nextBtnState++;
    switch (nextBtnState) {
      case 1:
        handleFirstClick();
        break;
      case 2:
        handleSecondClick();
        break;
      default:
        resetPage();
    }
  }

  function handleFirstClick() {
    updateScannedQRCodes();
    updateQRSummary();
    clearOrderInfo();
    addAgradeQuantity();
    showQuantityInput();
    disableAddButton();
  }

  function handleSecondClick() {
    if (!validateAGradeQuantity()) {
      return;
    }
    sendDataToServer();
  }

  function showQuantityInput() {
    $("#quantityInputContainer").show();
  }

  function sendDataToServer() {
    if (!validateAGradeQuantity()) {
      return;
    }

    $("#keypad").hide();
    $.ajax({
      url: "/data_monitoring/input_inspection/",
      type: "POST",
      data: JSON.stringify({
        scannedOrders: scannedQRCodes,
        quantityInput: quantityInput,
        machine: machineValue,
      }),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: handleServerResponse,
      error: handleServerError,
    });
  }

  const quantityInput = [{ Grade: "A", quantity: 0 }];

  function addAgradeQuantity() {
    parentDiv = $("#quantityInputTable");
    // Create flex container for horizontal alignment
    const flexContainer = $('<div class="d-flex align-items-center"></div>');

    // Add "A Grade" label
    const label = $(
      '<label style="width:50%; font-size:35px;">A Grade:</label>'
    );
    // Create input field for A Grade quantity
    const aGradeQuantityInput = $(
      '<input type="text" class="form-control form-control-lg numeric-input required" style="width:50%" placeholder="Qty *" required>'
    );
    aGradeQuantityInput.css("border-color", "#ff9999"); // Visual indicator for required field
    // Add unit label "M"
    const unitLabel = $('<span class="ml-2">M</span>');

    // Add label, input field and unit label to flex container
    flexContainer.append(label); // Add label
    flexContainer.append(aGradeQuantityInput); // Add input field
    flexContainer.append(unitLabel); // Add "M" label
    parentDiv.append(flexContainer); // Add complete flex container to parent div

    // Adjust position of addButtonContainer below flexContainer
    parentDiv.append(addButtonContainer); // Add addButtonContainer below flexContainer

    // Add required field message
    const requiredMessage = $(
      '<small class="text-danger">* Required field - Please enter quantity</small>'
    );
    aGradeQuantityInput.after(requiredMessage);

    // Add event handler for input field
    aGradeQuantityInput.on("input", function () {
      const value = $(this).val().trim();
      if (value !== "" && parseFloat(value) > 0) {
        $(this).css("border-color", "");
        requiredMessage.hide();
      } else {
        $(this).css("border-color", "#ff9999");
        requiredMessage.show();
      }

      const existingAgrade = quantityInput.find((x) => x.Grade === "A");
      if (existingAgrade) {
        existingAgrade.quantity = value ? parseFloat(value) : 0;
      }
    });
  }

  function addNewItem() {
    const parentDiv = $("#quantityInputTable");
    const addButtonContainer = $("#addButtonContainer");

    // Get and process defect causes
    const defectCauseOptions = JSON.parse("{{ defect_cause|escapejs }}");
    const sortedDefectCauses = Object.keys(defectCauseOptions).sort((a, b) =>
      defectCauseOptions[a].localeCompare(defectCauseOptions[b])
    );

    const defectCauseContainer = $(
      '<div class="defect-cause-container"></div>'
    ); // Create grid container

    // Add items in grid format
    sortedDefectCauses.forEach((key) => {
      const gridItem = $(
        `<div class="grid-item" data-key="${key}">${defectCauseOptions[key]}</div>`
      );
      gridItem.on("click", function () {
        const defectCauseKey = $(this).data("key");
        const defectCauseText = defectCauseOptions[defectCauseKey];
        $("#categoryModal").modal("hide"); // Close modal

        const flexContainer = $(
          '<div class="d-flex align-items-center"></div>'
        );

        // Add quantity input field
        const quantityInputField = $(
          `<input type="text" id="${defectCauseKey}" name="${defectCauseKey}" class="form-control form-control-lg numeric-input col-2" style="width:30%">`
        );
        const unitLabel = $('<span class="ml-2">M</span>');

        flexContainer.append(
          `<span class="mr-2"><h3>${defectCauseText}</h3></span>`
        ); // Add selected item name
        flexContainer.append(quantityInputField); // Add quantity input field to flex container
        flexContainer.append(unitLabel); // Add unit label to flex container
        parentDiv.append(flexContainer); // Add complete flex container to parent div
        parentDiv.append(addButtonContainer); // Add addButtonContainer below flex container

        quantityInputField.focus(); // Set focus to new input field

        // Add event handler for quantity input field
        quantityInputField.on("input", function () {
          const quantity = $(this).val();
          // Find current defectCauseKey in quantityInput array
          const existingItemIndex = quantityInput.findIndex(
            (x) => x.defectCause === defectCauseKey
          );

          if (existingItemIndex !== -1) {
            // If already exists, update quantity for this defectCause
            quantityInput[existingItemIndex].quantity = quantity;
          } else {
            // Add new defectCause to array
            quantityInput.push({
              defectCause: defectCauseKey,
              quantity: quantity,
            });
          }
        });
      });
      defectCauseContainer.append(gridItem);
    });

    $("#categoryModal .modal-body").html(defectCauseContainer); // Add grid container to modal body
    $("#categoryModal").modal("show"); // Show modal
  }

  // Add validation function for A Grade quantity
  function validateAGradeQuantity() {
    const aGradeInput = $("input.numeric-input.required").val();
    if (
      !aGradeInput ||
      aGradeInput.trim() === "" ||
      parseFloat(aGradeInput) <= 0
    ) {
      alert("Please enter A Grade quantity before continuing!");
      nextBtnState = 1;
      return false;
    }
    return true;
  }

  // Modify Next button behavior
  $("#nextButton").click(function () {
    if (!validateAGradeQuantity()) {
      return false; // Stop processing if A Grade quantity not entered
    }

    // ... rest of your existing next button code ...
  });
</script>
{% endblock %}
