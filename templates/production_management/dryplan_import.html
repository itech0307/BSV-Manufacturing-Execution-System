{% extends 'base/core.html' %}
{% load static %}
{% block content %}
<h3>DRYPLAN IMPORT</h3>

<form id="uploadForm" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="file" name="importData" />
  <input hidden type="text" name="title" value="CONVERT QR" />
  <p>Please select format of file.</p>
  <button class="btn btn-primary" type="submit">Convert</button>
</form>

<a href="#">Return Home View</a>

<div class="text-center" style="font-size: 14px">
  <div id="progress-bar-message"></div>
</div>

<div class="progress-wrapper" style="padding-top: 10px">
  <div
    id="progress-bar"
    class="progress-bar"
    style="background-color: #68a9ef; width: 0%"
  >
    &nbsp;
  </div>
</div>

<div id="celery-result"></div>

<div id="invalid-orders-container"></div>

{% endblock %} {% block extra_js %}
<script>
  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      // Lấy CSRF token từ cookie
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie("csrftoken");

      fetch('{% url "production_management:dryplan_import" %}', {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin", // Add credentials to send cookies
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          if (data.error) {
            alert(data.error);
            return;
          }

          // If there is a file to download
          if (data.file_content) {
            // Convert base64 string to blob
            const byteCharacters = atob(data.file_content);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);

            // Create blob and download
            const blob = new Blob([byteArray], { type: data.content_type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = data.filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
          }

          // Display list of invalid orders
          if (data.invalid_orders && data.invalid_orders.length > 0) {
            const container = document.getElementById(
              "invalid-orders-container"
            );
            let html = `
                <div class="alert alert-danger mt-3">
                    <h5><strong>Invalid order error:</strong></h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Row No.</th>
                                <th>Order No.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.invalid_orders.forEach((order) => {
              html += `
                    <tr>
                        <td>${order.row}</td>
                        <td>${order.order_no}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred while processing the request: " + error.message);
        });
    });
</script>
{% endblock %}
