{% extends 'common/main.html' %}
{% load forum_filters %}
{% block content %}
<div class="container my-3" data-development-id="{{ development.id }}">
    <!-- Display message -->
    {% if messages %}
    <div class="alert alert-danger my-3" role="alert">
    {% for message in messages %}
        <strong>{{ message.tags }}</strong>
        <ul><li>{{ message.message }}</li></ul>
    {% endfor %}
    </div>
    {% endif %}
    <!-- Content -->
    <h2 class="border-bottom py-2">[DEV-{{ development.id }}] {{ development.title }}</h2>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text">
                <p><b>[Purpose]</b> {{ development.purpose }}</p>
                <p><b>[Category]</b> {{ development.category }}</p>
                <p><b>[Deadline]</b> {{ development.deadline }}</p>
                <p><b>[Content]</b> {{ development.content|mark }}</p>
                {% with first_image=files|first_image %}
                    {% if first_image %}
                    <p><b>[Thumbnail]</b></p>
                    <img src="{{ first_image.url }}" alt="{{ first_image.name }}" class="img-fluid my-2" style="max-width: 400px;">
                    {% endif %}
                {% endwith %}
            </div>
            <h5 class="border-bottom py-2">Development Orders</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>OrderNo</th>
                        <th>Item</th>
                        <th>Color</th>
                        <th>Pattern</th>
                        <th>Spec</th>
                        <th>Qty(M)</th>
                        <th>Group</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>{{ order.order_no }}</td>
                        <td>{{ order.item_name }}</td>
                        <td>{{ order.color_code }}</td>
                        <td>{{ order.pattern }}</td>
                        <td>{{ order.spec }}</td>
                        <td>{{ order.order_qty }}</td>
                        <td>{{ order.product_group}}</td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button onclick="generateQRCode()" title="QR" style="background: none; border: none; cursor: pointer; margin: 0 10px;">
                <i class="fas fa-qrcode"></i>
            </button>
            <div class="d-flex justify-content-end">
                {% if development.modify_date %}
                <div class="badge bg-light text-dark p-2 text-start mx-3">
                    <div class="mb-2">modified at</div>
                    <div>{{ development.modify_date }}</div>
                </div>
                {% endif %}
                <div class="badge bg-light text-dark p-2 text-start">
                    <div class="mb-2">{{ development.developer.username }}</div>
                    <div>{{ development.create_date }}</div>
                </div>
            </div>
            <div class="my-3">
                {% if request.user == development.developer %}
                <a href="{% url 'production_management:development_modify' development.id  %}" 
                    class="btn btn-sm btn-outline-secondary">Modify</a>
                <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary"
                    data-uri="{% url 'production_management:development_delete' development.id  %}">Delete</a>
                {% if development.status == 'Progress' %}
                <a href="javascript:void(0)" class="btn btn-sm btn-outline-success" onclick="updateStatus('{{ development.id }}', 'Complete')">Complete</a>
                {% elif development.status == 'Complete' %}
                <a href="javascript:void(0)" class="btn btn-sm btn-outline-warning" onclick="updateStatus('{{ development.id }}', 'Progress')">Re-Processing</a>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add file list and upload section -->
    <div class="card my-3">
        <div class="card-body">
            <!-- File upload form -->
            <form action="{% url 'production_management:upload_development_file' development.id %}" method="post" enctype="multipart/form-data" class="mb-3">
                {% csrf_token %}
                <div class="input-group">
                    <input type="file" name="file" class="form-control" required>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
            
            <!-- File list -->
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td>{{ file.name }}</td>
                        <td>{{ file.size|filesizeformat }}</td>
                        <td>{{ file.last_modified|date:"Y-m-d H:i" }}</td>
                        <td>
                            <a href="{{ file.url }}" class="btn btn-sm btn-info" target="_blank">Download</a>
                            <a href="{% url 'production_management:delete_development_file' development.id file.name %}" 
                               class="btn btn-sm btn-danger" 
                               onclick="return confirm('Are you sure you want to delete this file?');">Delete</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No files found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Comment -->
    <h5 class="border-bottom my-3 py-2">There are {{ development.development_comment_set.count }} comments.</h5>
    {% for development_comment in development.development_comment_set.all %}
    <a id="comment_{{ development_comment.id }}"></a>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text">{{ development_comment.content|mark }}</div>
            <div class="d-flex justify-content-end">
                {% if development_comment.modify_date %}
                <div class="badge bg-light text-dark p-2 text-start mx-3">
                    <div class="mb-2">modified at</div>
                    <div>{{ development_comment.modify_date }}</div>
                </div>
                {% endif %}
                <div class="badge bg-light text-dark p-2 text-start">
                    <div class="mb-2">{{ development_comment.user.username }}</div>
                    <div>{{ development_comment.create_date }}</div>
                </div>
            </div>
            <div class="my-3">
                {% if request.user == development_comment.user %}
                <a href="{% url 'production_management:development_comment_modify' development_comment.id %}" 
                   class="btn btn-sm btn-outline-secondary">Modify</a>
                <a href="#" class="delete btn btn-sm btn-outline-secondary"
                   data-uri="{% url 'production_management:development_comment_delete' development_comment.id %}">Delete</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    <!-- Comment registration -->
    <form action="{% url 'production_management:development_comment_create' development.id %}" method="post" enctype="multipart/form-data" class="my-3">
        {% csrf_token %}
        <!-- Error display Start -->
        {% include "common/form_errors.html" %}
        <!-- Error display End -->
        <div class="mb-3">
            <label for="content" class="form-label">Content</label>
            <textarea {% if not user.is_authenticated %}disabled{% endif %}
            name="content" id="content" class="form-control" rows="3"></textarea>
        </div>
        <input type="submit" value="Comment" class="btn btn-primary" {% if not user.is_authenticated %}disabled{% endif %}>
    </form>
</div>
{% endblock %}
{% block script %}
<script type='text/javascript'>
const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("Are you sure you want to delete it?")) {
            location.href = this.dataset.uri;
        };
    });
});
function generateQRCode() {
    const container = document.querySelector('.container');  // Select the container element
    const developmentId = container.getAttribute('data-development-id');  // Get the value of the data-development-id attribute
    
    const table = document.querySelector('.table');  // Select the order table
    const rows = table.querySelectorAll('tbody tr');  // Select all rows
    let orderNumbers = [];

    rows.forEach(row => {
        const orderNoCell = row.cells[0];  // The 'Order No' column is the first column
        const orderNo = orderNoCell.textContent.trim();
        orderNumbers.push(orderNo);  // Add the order number to the array
    });

    const csrftoken = getCookie('csrftoken');  // Get the CSRF token
    const payload = {
        action: 'download_to_qrcard',
        order_numbers: orderNumbers.join(',')  // Convert the array to a string and send it
    };

    $.ajax({
        url: `/production_management/development/list/${developmentId}/`,  // Check the URL
        type: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: JSON.stringify(payload),
        contentType: "application/json; charset=utf-8",
        xhrFields: {
            responseType: 'blob'  // Receive the response as a blob
        },
        success: function(blob) {
            if (blob instanceof Blob) {  // Check if the response is a blob object
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "dev_qrcard_.xlsx"; // Set the download file name
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                console.error("Received response is not a Blob object");
                alert("Failed to download file. The response is not a valid Blob object.");
            }
        },
        error: function(xhr, status, error) {
            console.error("Error:", error);
            alert("Failed to download file.");
        }
    });
}
// Function to get the CSRF token from the cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateStatus(developmentId, newStatus) {
    const csrftoken = getCookie('csrftoken');
    const payload = {
        status: newStatus
    };

    $.ajax({
        url: `/production_management/development/update_status/${developmentId}/`,
        type: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: JSON.stringify(payload),
        contentType: "application/json; charset=utf-8",
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert("Failed to update status.");
            }
        },
        error: function(xhr, status, error) {
            console.error("Error:", error);
            alert("Failed to update status.");
        }
    });
}
</script>
{% endblock %}